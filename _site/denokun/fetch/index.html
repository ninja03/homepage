<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title></title>
    <link rel="stylesheet" href="/denokun/style.css">
  </head>
  <body>
    <div class="header" onclick="location.href = '.'">
      
    </div>
      <p>ブラウザからサーバに通信する</p>
<p>fetchJSONを使う</p>
<ul>
<li>JSONでサーバと通信する関数</li>
<li>引数はURLとJSON</li>
<li>Server.jsのapi()のpath(/api/xxx)とreq(JSON) に対応する</li>
<li>POSTメソッドが使用される</li>
<li>JSON以外が返されると例外が発生する</li>
</ul>
<p>タイムライン表示用HTMLを追加する</p>
<p>ローカルPCからサーバにデプロイしても動くように<br>
locationからサーバのURLを作成する</p>
<p>セッションはブラウザのローカルストレージに保管する</p>
<p><code>static/index.html</code></p>
<pre><code class="language-html">&lt;div x-data=&quot;app&quot;&gt;
  &lt;!-- タイムライン --&gt;
  &lt;div&gt;
    &lt;template x-for=&quot;photo in timeline&quot;&gt;
      &lt;div&gt;
        &lt;div x-text=&quot;photo.id&quot;&gt;&lt;/div&gt;
        &lt;img :src=&quot;photo.url&quot;&gt;
        &lt;button x-text=&quot;photo.good + 'いいね'&quot; @click=&quot;good(photo)&quot;&gt;&lt;/button&gt;
      &lt;/div&gt;
    &lt;/template&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;script type=&quot;module&quot;&gt;
  import Alpine from &quot;https://unpkg.com/alpinejs@3.2.3/dist/module.esm.js&quot;
  import { fetchJSON } from &quot;https://ninja03.github.io/denokun/lib/fetchJSON.js&quot;

  Alpine.data(&quot;app&quot;, () =&gt; ({
    server: location.protocol + &quot;//&quot; + location.hostname + &quot;:8881&quot;,

    userName: &quot;&quot;,      // ログイン中ユーザ名
    logined: false,    // ログイン中か
    timeline: [],      // タイムラインのデータ

    // API通信
    async fetchAPI(path, req = {}) {
      req.session = localStorage.session
      return await fetchJSON(this.server + &quot;/api/&quot; + path, req)
    },

    // ページを開いたときはユーザ取得とタイムラインを取得
    async init() {
      await this.reloadUser()
      await this.reloadTimeline()
    },

    // ユーザ取得
    async reloadUser() {
      try {
        const u = await this.fetchAPI(&quot;user&quot;)
        this.logined = true
        this.userName = u.name
      } catch {
        this.logined = false
        this.userName = null
      }
    },

    // タイムライン取得
    async reloadTimeline() {
      const sort = { &quot;新着順&quot;: &quot;new&quot;, &quot;人気順&quot;: &quot;trend&quot; }[this.sort]
      const path = this.logined ? &quot;timeline&quot; : &quot;public_timeline&quot;
      this.timeline = await this.fetchAPI(path, { sort: sort })
    },

    // 並び替えボタン
    sort: &quot;新着順&quot;,

    // タイムライン並び順変更
    async changeType() {
      this.sort = this.sort === &quot;新着順&quot; ? &quot;人気順&quot; : &quot;新着順&quot;
      await this.reloadTimeline()
    },

    // ユーザ登録ダイアログ
    showRegist: false, // ユーザ登録ダイアログ表示中か
    registName: &quot;&quot;,    // ユーザ登録ダイアログ名前入力値
    registPass: &quot;&quot;,    // ユーザ登録ダイアログパスワード入力値

    openRegist() {
      this.showRegist = true
    },

    closeRegist() {
      this.showRegist = false
    },

    // ユーザ登録
    async regist() {
      const r = await this.fetchAPI(&quot;regist&quot;, {
        name: this.registName,
        pass: this.registPass
      })
      if (r.err) {
        console.log(&quot;登録されています&quot;)
        return
      }
      localStorage.session = r.session
      await this.reloadUser()
      console.log(&quot;ユーザ登録しました&quot;)
      await this.reloadTimeline()
      this.closeRegist()
    }

    // ログインダイアログ
    showLogin: false,  // ログインダイアログ表示中か
    loginName: &quot;&quot;,     // ログインダイアログ名前入力値
    loginPass: &quot;&quot;,     // ログインダイアログパスワード入力値

    // ログインダイアログを開く
    openLogin() {
      this.showLogin = true
    },

    // ログインダイアログを閉じる
    closeLogin() {
      this.showLogin = false
    },

    // ログイン
    async login() {
      const r = await this.fetchAPI(&quot;login&quot;, {
        name: this.loginName,
        pass: this.loginPass
      })
      if (r.err) {
        console.log(&quot;ユーザ名かパスワードが違います&quot;)
        return
      }
      localStorage.session = r.session
      this.closeLogin()
      await this.reloadUser()
      console.log(&quot;ログインしました&quot;)
      await this.reloadTimeline()
    },

    // ログアウト
    async logout() {
      await this.fetchAPI(&quot;logout&quot;)
      delete localStorage.session
      this.logined = false
      this.reloadUser()
      console.log(&quot;ログアウトしました&quot;)
      await this.reloadTimeline()
    },

    // アップロードダイアログ
    showUpload: false, // アップロードダイアログ表示中か

    // アップロードダイアログを開く
    openUpload() {
      this.showUpload = true
    },

    // アップロードダイアログを閉じる
    closeUpload() {
      this.showUpload = false
    },

    // アップロードするファイルを選んだ
    fileSelected() {
    },

    // アップロードする
    upload() {
      this.closeUpload()
    }
  }))
&lt;/script&gt;
</code></pre>

  </body>
</html>